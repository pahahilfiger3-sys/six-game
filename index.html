<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
    <style> body { font-family: 'Orbitron', sans-serif; } </style>
</head>
<body>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="logo">SIX</div>
            <div class="online-tag">üü¢ 1,240 Online</div>
            <button class="big-btn" onclick="startSearching()">START</button>
            <div style="margin-top: 30px; opacity: 0.6; font-size: 12px;">–ë–∞–ª–∞–Ω—Å: <b id="user-balance">100 ü™ô</b></div>
            <div style="margin-top:10px; font-size:10px; color:#666;" id="debug-id"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üí¨</div>
            <div class="nav-item" onclick="buyPack()">üõç</div>
            <div class="nav-item">üë§</div>
        </div>
    </div>

    <div id="screen-search" class="screen">
        <div style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:80px; height:80px; border:4px solid var(--neon-blue); border-radius:50%; border-top-color:transparent; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
            <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            <div>–ò—â–µ–º –ø–∞—Ä—É...</div>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header"><span>TABLE #1</span><span id="game-timer">00:00</span></div>
        
        <div class="top-spotlight" id="top-bar">
            <div class="q-content" id="q-box-content">
                <div class="q-label">–†–ê–£–ù–î 1</div>
                <div class="q-text" id="q-text-val">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="player-content" id="player-box-content" style="display:none;">
                <div class="play-btn">‚ñ∂Ô∏è</div>
                <div class="wave-visual"><div class="wave-fill"></div></div>
                <div style="font-size:12px; font-weight:bold;">0:15</div>
            </div>
        </div>
        
        <div class="center-wrapper"> 
            <div class="table-grid">
                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/44.jpg')"></div><div class="name-tag">–ê–Ω—è</div></div>
                
                <div class="player-card team-left" onclick="voteFor('–û–ø–ø–æ–Ω–µ–Ω—Ç')">
                    <div class="avatar blurred" id="opponent-avatar"></div>
                    <div class="name-tag" id="opponent-name" style="color:var(--neon-pink)">...</div>
                </div>

                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/68.jpg')"></div><div class="name-tag">–û–ª—è</div></div>
                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/32.jpg')"></div><div class="name-tag">–ú–∞–∫—Å</div></div>
                
                <div class="player-card team-right">
                    <div class="avatar" id="my-avatar"></div>
                    <div class="name-tag" style="color:var(--neon-blue)">–í–´</div>
                </div>

                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/86.jpg')"></div><div class="name-tag">–î—ç–Ω</div></div>
            </div>
        </div>

        <div class="mic-wrapper" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);">
            <button class="mic-btn" id="mic-btn" onclick="toggleRecording()">üé§</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0b0b14'); 
        tg.setBackgroundColor('#0b0b14');

        const u = tg.initDataUnsafe.user;
        let USER_ID;
        // –ë–ï–†–ï–ú –†–ï–ê–õ–¨–ù–´–ô ID
        if (u && u.id) {
            USER_ID = u.id;
        } else {
            // –§–æ–ª–±—ç–∫ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ (—á—Ç–æ–±—ã —Ç–µ—Å—Ç –Ω–µ –ø–∞–¥–∞–ª)
            let storedId = localStorage.getItem('six_real_id');
            if (!storedId) {
                storedId = Math.floor(Math.random() * 1000000);
                localStorage.setItem('six_real_id', storedId);
            }
            USER_ID = parseInt(storedId);
        }

        document.getElementById('debug-id').innerText = "–í–∞—à ID: " + USER_ID;

        const myName = (u && u.first_name) ? u.first_name : "–ò–≥—Ä–æ–∫";
        const myPhoto = (u && u.photo_url) ? u.photo_url : "";

        if (myPhoto) {
            document.getElementById('my-avatar').style.backgroundImage = `url('${myPhoto}')`;
        }

        const UPLOAD_URL = 'https://api.sixapp.online/audio/upload';
        const SEARCH_URL = 'https://api.sixapp.online/search';

        let searchInterval;

        async function startSearching() {
            tg.HapticFeedback.impactOccurred('heavy');
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-search').classList.add('active');
            startPolling();
        }

        function startPolling() {
            searchInterval = setInterval(async () => {
                try {
                    const response = await fetch(SEARCH_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: USER_ID, name: myName })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'matched' || data.status === 'matched_wait') {
                        clearInterval(searchInterval);
                        document.getElementById('screen-search').classList.remove('active');
                        document.getElementById('screen-game').classList.add('active');
                        setupGame(); 
                        tg.HapticFeedback.notificationOccurred('success');
                    }
                } catch (error) {
                    console.error("Polling error:", error);
                }
            }, 2000); 
        }

        function setupGame() {
            document.getElementById('opponent-name').innerText = "–ò–Ω–∫–æ–≥–Ω–∏—Ç–æ";
            const oppAva = document.getElementById('opponent-avatar');
            oppAva.classList.add('blurred');
            oppAva.style.backgroundImage = `url('https://randomuser.me/api/portraits/women/20.jpg')`;
            runRound(1);
        }

        function runRound(num) {
            document.getElementById('q-text-val').innerText = "–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π?";
            let timeLeft = 15;
            const timer = document.getElementById('game-timer');
            const interval = setInterval(() => {
                timeLeft--;
                timer.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                if (timeLeft <= 0) clearInterval(interval);
            }, 1000);
        }

        let isRecording = false;
        let mediaRecorder; 
        let audioChunks = []; 

        async function toggleRecording() {
            const btn = document.getElementById('mic-btn');
            const qBox = document.getElementById('q-box-content');
            const playerBox = document.getElementById('player-box-content');
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = sendAudioData;
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    qBox.style.display = 'none';
                    playerBox.style.display = 'flex';
                    playerBox.innerHTML = `<div style="font-size:12px; color:red;">–ó–ê–ü–ò–°–¨...</div>`;
                } catch (err) { alert('–ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞'); }
            } else {
                isRecording = false;
                btn.classList.remove('recording');
                if (mediaRecorder) mediaRecorder.stop();
                playerBox.innerHTML = `<div style="color:#00ff88; font-size:12px;">–û–¢–ü–†–ê–í–ö–ê...</div>`;
            }
        }
        
        function sendAudioData() {
            if (audioChunks.length === 0) return;
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
            const formData = new FormData();
            formData.append('audio_file', audioBlob, `voice_${Date.now()}.ogg`);
            formData.append('user_id', USER_ID); 
            fetch(UPLOAD_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                alert('‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
                document.getElementById('player-box-content').style.display = 'none';
                document.getElementById('q-box-content').style.display = 'block';
            })
            .catch(err => alert('–û—à–∏–±–∫–∞: ' + err));
        }

        function sendGift(type) { alert(`–ü–æ–¥–∞—Ä–æ–∫: ${type}`); }
        function voteFor() { alert("–ì–æ–ª–æ—Å –ø—Ä–∏–Ω—è—Ç!"); }
        function skipVote() { alert("–°–∫–∏–ø!"); }
        function buyPack() {}
        function closeApp() { tg.close(); }
    </script>
</body>
</html>
