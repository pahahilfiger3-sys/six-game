<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Orbitron', sans-serif; }
        
        /* üõ† –û–¢–õ–ê–î–û–ß–ù–ê–Ø –ö–û–ù–°–û–õ–¨ (–ß–ï–†–ù–ê–Ø –ü–û–õ–û–°–ê –°–ù–ò–ó–£) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(0,0,0,0.85); color: #00ff00; font-size: 10px;
            font-family: monospace; overflow-y: scroll; z-index: 10000;
            padding: 5px; pointer-events: none; border-top: 2px solid #00ff00;
        }

        /* üíÑ –ù–û–í–´–ô –°–¢–ò–õ–¨ –ë–õ–Æ–†–ê (–õ–µ–≥–∫–∏–π, "–ú–∞—Ç–æ–≤–æ–µ —Å—Ç–µ–∫–ª–æ") */
        .blurred {
            filter: blur(8px) brightness(0.8) !important;
            transition: filter 1s ease;
        }
        
        .unblurred {
            filter: blur(0px) !important;
        }

        /* üíÑ –°–¢–ò–õ–¨ –ö–ù–û–ü–ö–ò PLAY (–ß–µ—Ç–∫–∞—è, –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ) */
        .notify-badge {
            position: absolute;
            bottom: -5px; /* –ß—É—Ç—å –≤—ã–ª–µ–∑–∞–µ—Ç –∑–∞ –∞–≤–∞—Ç–∞—Ä–∫—É */
            right: -5px;
            width: 30px; 
            height: 30px;
            background: #ff0055; /* –Ø—Ä–∫–∏–π –Ω–µ–æ–Ω */
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 0 10px #ff0055;
            z-index: 100; /* –í–ê–ñ–ù–û: –ü–æ–≤–µ—Ä—Ö –±–ª—é—Ä–∞ */
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none; /* –ß—Ç–æ–±—ã –∫–ª–∏–∫ –ø—Ä–æ—Ö–æ–¥–∏–ª —Å–∫–≤–æ–∑—å –∏–∫–æ–Ω–∫—É –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫—É */
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        /* –ö–ù–û–ü–ö–ê –ê–í–ê–†–ò–ô–ù–û–ì–û –í–´–•–û–î–ê */
        .force-exit-btn {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 0, 0, 0.5); color: white;
            border: 1px solid red; font-size: 10px; padding: 5px;
            z-index: 5000; cursor: pointer;
        }
        
        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫, —á—Ç–æ–±—ã –∑–Ω–∞—á–æ–∫ –ª–∏–ø –ø—Ä–∞–≤–∏–ª—å–Ω–æ */
        .player-card {
            position: relative; 
        }
    </style>
</head>
<body>

    <div id="debug-console">–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞...</div>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="logo">SIX</div>
            <div class="online-tag">üü¢ ONLINE</div>
            <button class="big-btn" onclick="startSearching()">START</button>
            <div style="margin-top: 30px; opacity: 0.6; font-size: 12px;">–ë–∞–ª–∞–Ω—Å: <b id="user-balance">100 ü™ô</b></div>
            <div style="margin-top:10px; font-size:10px; color:#666;" id="debug-id"></div>
            <div style="margin-top:5px; font-size:10px; color:#666;" id="my-name-label"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üí¨</div>
            <div class="nav-item">üõç</div>
            <div class="nav-item">üë§</div>
        </div>
    </div>

    <div id="screen-search" class="screen">
        <div style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:80px; height:80px; border:4px solid var(--neon-blue); border-radius:50%; border-top-color:transparent; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
            <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            <div>–ò—â–µ–º –ø–∞—Ä—É...</div>
            <button onclick="forceExit()" style="margin-top:20px; background:none; border:1px solid #444; color:#666;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button class="force-exit-btn" onclick="forceExit()">üö™ –í–´–ô–¢–ò</button>

        <div class="game-header"><span>TABLE #1</span><span id="game-timer">00:00</span></div>
        
        <div class="top-spotlight" id="top-bar">
            <div class="q-content" id="q-box-content">
                <div class="q-label">–†–ê–£–ù–î 1</div>
                <div class="q-text" id="q-text-val">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="player-content" id="player-box-content" style="display:none;">
                <div class="play-btn">‚ñ∂Ô∏è</div>
                <div class="wave-visual"><div class="wave-fill"></div></div>
                <div style="font-size:12px; font-weight:bold;">0:15</div>
            </div>
        </div>
        
        <div class="center-wrapper"> 
            <div class="table-grid">
                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/44.jpg')"></div><div class="name-tag">–ê–Ω—è</div></div>
                
                <div class="player-card team-left" id="opponent-card">
                    <div class="avatar" id="opponent-avatar"></div>
                    <div class="name-tag" id="opponent-name" style="color:var(--neon-pink)">...</div>
                    </div>

                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/68.jpg')"></div><div class="name-tag">–û–ª—è</div></div>
                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/32.jpg')"></div><div class="name-tag">–ú–∞–∫—Å</div></div>
                
                <div class="player-card team-right">
                    <div class="avatar" id="my-avatar"></div>
                    <div class="name-tag" style="color:var(--neon-blue)">–í–´</div>
                </div>

                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/86.jpg')"></div><div class="name-tag">–î—ç–Ω</div></div>
            </div>
        </div>

        <div class="mic-wrapper" id="mic-wrapper" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);">
            <button class="mic-btn" id="mic-btn" onclick="toggleRecording()">üé§</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0b0b14'); tg.setBackgroundColor('#0b0b14');

        function log(msg) {
            const el = document.getElementById('debug-console');
            el.innerText = msg + "\n" + el.innerText;
            console.log(msg);
        }

        const UPLOAD_URL = 'https://api.sixapp.online/audio/upload';
        const SEARCH_URL = 'https://api.sixapp.online/search';

        // --- –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø ---
        const u = tg.initDataUnsafe.user;
        let USER_ID;
        let myName = "–ò–≥—Ä–æ–∫"; 
        let myPhoto = "";

        const testNames = ["–ê–ª–µ–∫—Å", "–ú–∞–∫—Å", "–î—ç–Ω", "–û–ª—è", "–ö–∞—Ç—è", "–ù–∏–∫", "–õ–∏–∑–∞"];
        const randomNum = Math.floor(Math.random() * 999);
        const randomName = testNames[Math.floor(Math.random() * testNames.length)] + " #" + randomNum;

        if (u && u.id) {
            log(`TG User: ${u.first_name} (${u.id})`);
            USER_ID = u.id;
            myName = u.first_name || "–ê–Ω–æ–Ω–∏–º";
            myPhoto = u.photo_url || "";
        } else {
            log("Browser Mode");
            let storedId = localStorage.getItem('six_real_id_v3'); 
            if (!storedId) {
                storedId = Math.floor(Math.random() * 1000000) + 1;
                localStorage.setItem('six_real_id_v3', storedId);
            }
            USER_ID = parseInt(storedId);
            
            let storedName = localStorage.getItem('six_test_name_v3');
            if (!storedName) {
                storedName = randomName;
                localStorage.setItem('six_test_name_v3', storedName);
            }
            myName = storedName;
        }

        document.getElementById('debug-id').innerText = "ID: " + USER_ID;
        document.getElementById('my-name-label').innerText = myName;

        if (myPhoto) {
            document.getElementById('my-avatar').style.backgroundImage = `url('${myPhoto}')`;
        }

        let searchInterval;
        let currentPhase = "";
        let currentAudio = null;

        // --- –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø ---
        
        function forceExit() {
            log("üö™ –í–´–•–û–î");
            clearInterval(searchInterval);
            document.getElementById('screen-game').classList.remove('active');
            document.getElementById('screen-search').classList.remove('active');
            document.getElementById('screen-lobby').classList.add('active');
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            currentPhase = "";
        }

        async function checkActiveGame() {
            try {
                const response = await fetch(SEARCH_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: USER_ID, name: myName, photo: myPhoto })
                });
                const data = await response.json();

                if (data.status === 'in_game') {
                    log("‚ôªÔ∏è –ê–í–¢–û-–†–ï–ö–û–ù–ù–ï–ö–¢...");
                    document.getElementById('screen-lobby').classList.remove('active');
                    document.getElementById('screen-game').classList.add('active');
                    startPolling();
                }
            } catch (e) { log("Check err: " + e); }
        }

        async function startSearching() {
            tg.HapticFeedback.impactOccurred('heavy');
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-search').classList.add('active');
            startPolling();
        }

        function startPolling() {
            if (searchInterval) clearInterval(searchInterval);

            searchInterval = setInterval(async () => {
                try {
                    const response = await fetch(SEARCH_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: USER_ID, name: myName, photo: myPhoto })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'in_game') {
                        if (!document.getElementById('screen-game').classList.contains('active')) {
                            document.getElementById('screen-search').classList.remove('active');
                            document.getElementById('screen-game').classList.add('active');
                        }
                        updateGameUI(data);
                    }
                    else if (data.status === 'searching') {
                        if (document.getElementById('screen-game').classList.contains('active')) {
                             log("–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞ —Å–µ—Ä–≤–µ—Ä–æ–º.");
                             forceExit();
                        }
                    }
                } catch (error) { console.error("Poll err"); }
            }, 1000); 
        }

        function updateGameUI(data) {
            const timer = document.getElementById('game-timer');
            timer.innerText = `00:${data.time_left}`;
            document.getElementById('q-text-val').innerText = data.question;

            const oppNameEl = document.getElementById('opponent-name');
            if (oppNameEl.innerText !== data.opponent_name) {
                oppNameEl.innerText = data.opponent_name;
                const oppAva = document.getElementById('opponent-avatar');
                const photo = (data.opponent_photo && data.opponent_photo !== "null") ? data.opponent_photo : 'https://randomuser.me/api/portraits/lego/1.jpg';
                oppAva.style.backgroundImage = `url('${photo}')`;
                oppAva.classList.add('blurred'); // –õ–µ–≥–∫–∏–π –±–ª—é—Ä
            }

            if (currentPhase !== data.phase) {
                currentPhase = data.phase;
                log(`–§–ê–ó–ê: ${currentPhase}`);
                
                if (currentPhase === 'recording') {
                    document.getElementById('mic-wrapper').style.display = 'flex';
                    document.getElementById('player-box-content').style.display = 'none';
                    document.getElementById('q-box-content').style.display = 'block';
                    
                    // –£–±–∏—Ä–∞–µ–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–∫–∏
                    document.querySelectorAll('.notify-badge').forEach(e => e.remove());
                } 
                else if (currentPhase === 'listening') {
                    document.getElementById('mic-wrapper').style.display = 'none';
                    tg.HapticFeedback.notificationOccurred('warning');
                }
            }

            // üî• –õ–û–ì–ò–ö–ê –ó–ù–ê–ß–ö–ê PLAY (–ò–°–ü–†–ê–í–õ–ï–ù–ê–Ø: –í–ù–ï –ë–õ–Æ–†–ê)
            if (data.phase === 'listening' && data.opponent_audio) {
                 // –ú—ã –∏—â–µ–º –ö–ê–†–¢–û–ß–ö–£ (—Ä–æ–¥–∏—Ç–µ–ª—è), –∞ –Ω–µ –∞–≤–∞—Ç–∞—Ä–∫—É
                 // –í HTML —è –¥–æ–±–∞–≤–∏–ª id="opponent-card" –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
                 const oppCard = document.getElementById('opponent-card') || document.getElementById('opponent-avatar').parentElement;
                 
                 if (!oppCard.querySelector('.notify-badge')) {
                     log("‚úÖ –ö–ù–û–ü–ö–ê PLAY –°–û–ó–î–ê–ù–ê (–í–ù–ï –ë–õ–Æ–†–ê)");
                     const badge = document.createElement('div');
                     badge.className = 'notify-badge';
                     badge.innerText = '‚ñ∂Ô∏è';
                     
                     // –ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–µ–µ—Ä
                     oppCard.onclick = function() { 
                         playOpponentAudio(data.opponent_audio); 
                     };
                     
                     oppCard.appendChild(badge); // –ö—Ä–µ–ø–∏–º –∫ –∫–∞—Ä—Ç–æ—á–∫–µ!
                     tg.HapticFeedback.notificationOccurred('success');
                 }
            }
        }

        function playOpponentAudio(audioUrl) {
             log("Play: " + audioUrl);
             tg.HapticFeedback.impactOccurred('medium');
             
             if (currentAudio) { currentAudio.pause(); currentAudio = null; }

             document.getElementById('q-box-content').style.display = 'none';
             const pBox = document.getElementById('player-box-content');
             pBox.style.display = 'flex';
             pBox.innerHTML = `
                <div class="play-btn" onclick="stopAudio()">‚è∏</div>
                <div style="font-size:10px; color:var(--neon-pink); margin-right:5px;">–°–û–ü–ï–†–ù–ò–ö</div>
                <div class="wave-visual"><div class="wave-fill" style="animation: fillWave 5s linear forwards;"></div></div>
            `;

            currentAudio = new Audio(audioUrl);
            currentAudio.play()
                .then(() => log("üîä –ó–í–£–ö –ò–î–ï–¢"))
                .catch(e => {
                    log("‚ùå Error: " + e);
                    alert("–û—à–∏–±–∫–∞: " + e);
                });

            currentAudio.onended = function() { stopAudio(); };
        }

        function stopAudio() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            document.getElementById('player-box-content').style.display = 'none';
            document.getElementById('q-box-content').style.display = 'block';
        }

        // --- –ó–ê–ü–ò–°–¨ ---
        let isRecording = false;
        let mediaRecorder; 
        let audioChunks = []; 

        async function toggleRecording() {
            if (currentPhase !== 'recording') return;
            const btn = document.getElementById('mic-btn');
            const playerBox = document.getElementById('player-box-content');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = sendAudioData;
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    tg.HapticFeedback.impactOccurred('medium');
                    document.getElementById('q-box-content').style.display = 'none';
                    if(playerBox) {
                        playerBox.style.display = 'flex';
                        playerBox.innerHTML = `<div style="color:red; font-size:12px;">–ó–ê–ü–ò–°–¨...</div>`;
                    }
                    log("Mic ON");
                } catch (err) { alert('–ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞'); }
            } else {
                isRecording = false;
                btn.classList.remove('recording');
                if (mediaRecorder) mediaRecorder.stop();
                log("Mic OFF");
                if(playerBox) playerBox.innerHTML = `<div style="color:#00ff88; font-size:12px;">–û–¢–ü–†–ê–í–ö–ê...</div>`;
            }
        }
        
        function sendAudioData() {
            if (audioChunks.length === 0) return;
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
            const formData = new FormData();
            formData.append('audio_file', audioBlob, `voice_${Date.now()}.ogg`);
            formData.append('user_id', USER_ID); 

            fetch(UPLOAD_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                log("Upload: " + data.status);
                const pBox = document.getElementById('player-box-content');
                const qBox = document.getElementById('q-box-content');
                if (pBox) pBox.style.display = 'none';
                if (qBox) qBox.style.display = 'block';
            })
            .catch(err => log('Err: ' + err));
        }

        function sendGift(type) { tg.HapticFeedback.impactOccurred('medium'); alert(`–ü–æ–¥–∞—Ä–æ–∫: ${type}`); }
        function voteFor(name) {}
        function skipVote() {}
        function buyPack() { tg.sendData(JSON.stringify({action:"buy_pack"})); }
        function closeApp() { tg.close(); }

        checkActiveGame();
    </script>
</body>
</html>
