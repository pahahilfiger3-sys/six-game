<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --neon-blue: #00f3ff; --neon-pink: #ff00ff; --bg-dark: #0b0b14; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg-dark); color: white; font-family: 'Montserrat', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        
        .screen { display: none; height: 100%; flex-direction: column; }
        .screen.active { display: flex; }

        /* ЛОББИ */
        .lobby-container { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .logo { font-size: 60px; font-weight: 900; text-shadow: 0 0 20px var(--neon-pink); margin-bottom: 20px; }
        
        /* КНОПКА СТАРТ - МАКСИМАЛЬНЫЙ Z-INDEX */
        .big-btn {
            background: linear-gradient(135deg, #ff0055, #ff00aa);
            width: 200px; height: 200px; border-radius: 50%; border: none;
            color: white; font-size: 28px; font-weight: 900;
            box-shadow: 0 0 40px rgba(255, 0, 85, 0.4);
            cursor: pointer;
            position: relative; z-index: 2147483647; /* ВЫШЕ ВСЕГО */
            pointer-events: auto;
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* ИГРА */
        .game-header { padding: 15px; display: flex; justify-content: space-between; font-weight: bold; }
        .table-grid { flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 10px; align-content: center; }
        .player-card { display: flex; flex-direction: column; align-items: center; }
        .avatar { width: 70px; height: 70px; border-radius: 50%; background: #333; background-size: cover; border: 3px solid #333; }
        .blurred { filter: blur(10px); }
        .unblurred { filter: blur(0px); }
        
        .question-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; background: rgba(20,20,30,0.9); padding: 20px; border: 1px solid var(--neon-blue); border-radius: 15px; text-align: center; z-index: 50; transition: opacity 0.3s; }
        
        .vote-layer { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 90; display: none; flex-direction: column; justify-content: space-between; padding: 60px 20px; }
        .vote-title { text-align: center; font-size: 24px; font-weight: bold; }
        .skip-btn { background: transparent; border: 2px solid #555; color: #aaa; padding: 15px; width: 100%; border-radius: 15px; font-size: 16px; margin-bottom: 20px; }
        .highlight { z-index: 100; transform: scale(1.1); border-color: #00ff88; }
    </style>
</head>
<body>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="logo">SIX</div>
            <button class="big-btn" onclick="startSearching()">START</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="game-header"><span>TABLE #1</span><span id="game-timer">00:05</span></div>
        <div class="table-grid">
            <div class="player-card"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/1.jpg')"></div><span>Аня</span></div>
            <div class="player-card"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/1.jpg')"></div><span>Макс</span></div>
            <div class="player-card" onclick="voteFor('Оппонент')">
                <div class="avatar" id="opponent-avatar"></div><span id="opponent-name" style="color:magenta">Катя</span>
            </div>
            <div class="player-card">
                <div class="avatar" id="my-avatar"></div><span style="color:cyan">ВЫ</span>
            </div>
            <div class="player-card"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/2.jpg')"></div><span>Оля</span></div>
            <div class="player-card"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/2.jpg')"></div><span>Дэн</span></div>
        </div>
        <div class="question-overlay" id="q-box">Загрузка...</div>
        <div class="vote-layer" id="vote-screen">
            <div class="vote-title">КТО ПОНРАВИЛСЯ? ❤️</div>
            <button class="skip-btn" onclick="skipVote()">НИКТО</button>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        // Данные юзера
        const u = tg.initDataUnsafe.user;
        if (u && u.photo_url) document.getElementById('my-avatar').style.backgroundImage = `url('${u.photo_url}')`;

        // Роутинг
        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');
        
        if (mode === 'game') {
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            setupGame();
        }

        // --- ПОИСК ---
        function startSearching() {
            // ДИАГНОСТИКА
            alert("Клик прошел! Ищем...");
            
            tg.HapticFeedback.impactOccurred('heavy');
            const photo = u ? u.photo_url : "";
            tg.sendData(JSON.stringify({action:"search", photo: photo}));
        }

        // --- ИГРА ---
        function setupGame() {
            const q1 = decodeURIComponent(urlParams.get('q1') || "Вопрос 1");
            const q2 = decodeURIComponent(urlParams.get('q2') || "Вопрос 2");
            const oppPhoto = urlParams.get('opp_photo');
            const oppName = urlParams.get('opp_name');

            if (oppName) document.getElementById('opponent-name').innerText = decodeURIComponent(oppName);
            const oppAvatar = document.getElementById('opponent-avatar');
            if (oppPhoto && oppPhoto !== "null") oppAvatar.style.backgroundImage = `url('${decodeURIComponent(oppPhoto)}')`;
            
            oppAvatar.classList.add('blurred');

            runRound(1, q1, q2);
        }

        function runRound(num, q1, q2) {
            const text = (num === 1) ? q1 : q2;
            const qBox = document.getElementById('q-box');
            qBox.style.opacity = 0;
            setTimeout(() => { qBox.innerHTML = `РАУНД ${num}<br>${text}`; qBox.style.opacity = 1; }, 300);

            let timeLeft = 5;
            const timer = document.getElementById('game-timer');
            
            const interval = setInterval(() => {
                timeLeft--;
                timer.innerText = `00:0${timeLeft}`;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    if (num === 1) runRound(2, q1, q2);
                    else endGame();
                }
            }, 1000);
        }

        function endGame() {
            document.getElementById('q-box').style.opacity = 0;
            document.getElementById('vote-screen').style.display = 'flex';
            document.querySelectorAll('.player-card').forEach(p => p.style.zIndex = 100);
        }

        function voteFor(name) {
            if (document.getElementById('vote-screen').style.display !== 'flex') return;
            document.getElementById('vote-screen').style.display = 'none';
            
            // Эффект
            const oppAvatar = document.getElementById('opponent-avatar');
            oppAvatar.classList.remove('blurred');
            oppAvatar.classList.add('unblurred');

            const isLiked = (name !== 'Никто');
            setTimeout(() => {
                tg.sendData(JSON.stringify({action: "vote", liked: isLiked}));
            }, 1500);
        }
        
        function skipVote() { voteFor('Никто'); }
    </script>
</body>
</html>
