<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Orbitron', sans-serif; }
        
        /* –õ–û–ì–ò (–í—Ä–µ–º–µ–Ω–Ω–æ –æ—Å—Ç–∞–≤–∏–º, —á—Ç–æ–±—ã —Ç—ã –≤–∏–¥–µ–ª, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0,0,0,0.9); color: #00ff00; font-size: 10px;
            font-family: monospace; overflow-y: scroll; z-index: 10000;
            padding: 5px; pointer-events: none; border-top: 2px solid #00ff00;
            display: block; /* –ï—Å–ª–∏ –º–µ—à–∞–µ—Ç - –ø–æ—Å—Ç–∞–≤—å none */
        }

        .blurred {
            filter: blur(8px) brightness(0.8) !important;
            transition: filter 0.5s ease;
        }
        
        /* –ó–ù–ê–ß–û–ö PLAY */
        .player-card { position: relative; }
        .notify-badge {
            position: absolute;
            bottom: -5px; right: -5px;
            width: 32px; height: 32px;
            background: #ff0055; color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 0 8px #ff0055;
            z-index: 200; cursor: pointer;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        .force-exit-btn {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 0, 0, 0.6); color: white;
            border: 1px solid red; font-size: 10px; padding: 6px 10px;
            border-radius: 4px; z-index: 5000; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="debug-console">–ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.</div>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="logo">SIX</div>
            <div class="online-tag">üü¢ ONLINE</div>
            <button class="big-btn" onclick="startSearching()">START</button>
            <div style="margin-top: 30px; opacity: 0.6; font-size: 12px;">–ë–∞–ª–∞–Ω—Å: <b id="user-balance">100 ü™ô</b></div>
            <div style="margin-top:10px; font-size:10px; color:#666;" id="debug-id"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üí¨</div>
            <div class="nav-item">üõç</div>
            <div class="nav-item">üë§</div>
        </div>
    </div>

    <div id="screen-search" class="screen">
        <div style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:80px; height:80px; border:4px solid var(--neon-blue); border-radius:50%; border-top-color:transparent; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
            <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            <div>–ò—â–µ–º –ø–∞—Ä—É...</div>
            <button onclick="forceExit()" style="margin-top:20px; color:#666; background:none; border:1px solid #444; padding:5px 10px;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button class="force-exit-btn" onclick="forceExit()">üö™ –í–´–•–û–î</button>

        <div class="game-header"><span>TABLE #1</span><span id="game-timer">00:00</span></div>
        
        <div class="top-spotlight" id="top-bar">
            <div class="q-content" id="q-box-content">
                <div class="q-label">–†–ê–£–ù–î 1</div>
                <div class="q-text" id="q-text-val">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="player-content" id="player-box-content" style="display:none;">
                <div class="play-btn">‚ñ∂Ô∏è</div>
                <div class="wave-visual"><div class="wave-fill"></div></div>
                <div style="font-size:12px; font-weight:bold;">0:15</div>
            </div>
        </div>
        
        <div class="center-wrapper"> 
            <div class="table-grid">
                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/44.jpg')"></div><div class="name-tag">–ê–Ω—è</div></div>
                
                <div class="player-card team-left" id="opponent-card">
                    <div class="avatar" id="opponent-avatar"></div>
                    <div class="name-tag" id="opponent-name" style="color:var(--neon-pink)">...</div>
                </div>

                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/68.jpg')"></div><div class="name-tag">–û–ª—è</div></div>
                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/32.jpg')"></div><div class="name-tag">–ú–∞–∫—Å</div></div>
                
                <div class="player-card team-right">
                    <div class="avatar" id="my-avatar"></div>
                    <div class="name-tag" id="my-name-label" style="color:var(--neon-blue)">–í–´</div>
                </div>

                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/86.jpg')"></div><div class="name-tag">–î—ç–Ω</div></div>
            </div>
        </div>

        <div class="controls-container" id="controls">
            <div class="side-col left">
                <div class="gift-btn" onclick="sendGift('ice')"><div class="gift-price">10</div></div>
                <div class="gift-btn" onclick="sendGift('fire')"><div class="gift-price">25</div></div>
            </div>
            <div class="mic-wrapper" id="mic-wrapper">
                <button class="mic-btn" id="mic-btn" onclick="toggleRecording()">üé§</button>
            </div>
            <div class="side-col right">
                <div class="gift-btn" onclick="sendGift('spy')"><div class="gift-price">100</div></div>
                <div class="gift-btn" onclick="sendGift('drink')"><div class="gift-price">50</div></div>
            </div>
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0b0b14'); tg.setBackgroundColor('#0b0b14');

        function log(msg) {
            const el = document.getElementById('debug-console');
            if(el) el.innerText = msg + "\n" + el.innerText;
            console.log(msg);
        }

        const UPLOAD_URL = 'https://api.sixapp.online/audio/upload';
        const SEARCH_URL = 'https://api.sixapp.online/search';

        // --- –ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø (v4 –¥–ª—è —Å–±—Ä–æ—Å–∞) ---
        const u = tg.initDataUnsafe.user;
        let USER_ID, myName = "–ò–≥—Ä–æ–∫", myPhoto = "";

        if (u && u.id) {
            USER_ID = u.id;
            myName = u.first_name || "–ê–Ω–æ–Ω–∏–º";
            myPhoto = u.photo_url || "";
        } else {
            let storedId = localStorage.getItem('six_real_id_v4'); 
            if (!storedId) {
                storedId = Math.floor(Math.random() * 1000000) + 1;
                localStorage.setItem('six_real_id_v4', storedId);
            }
            USER_ID = parseInt(storedId);
            myName = "–¢–µ—Å—Ç " + USER_ID;
        }

        document.getElementById('debug-id').innerText = "ID: " + USER_ID;
        document.getElementById('my-name-label').innerText = myName;
        if (myPhoto) document.getElementById('my-avatar').style.backgroundImage = `url('${myPhoto}')`;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let searchInterval = null;
        let currentPhase = "";
        let currentAudio = null;
        let isGameEnding = false; // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Å–ø–∞–º–∞ –∞–ª–µ—Ä—Ç–æ–≤

        // üü¢ –§–£–ù–ö–¶–ò–Ø –ü–û–õ–ù–û–ì–û –í–´–•–û–î–ê
        function forceExit() {
            log("üõë EXIT");
            if (searchInterval) {
                clearInterval(searchInterval);
                searchInterval = null;
            }
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            
            // –°–±—Ä–æ—Å UI
            document.getElementById('screen-game').classList.remove('active');
            document.getElementById('screen-search').classList.remove('active');
            document.getElementById('screen-lobby').classList.add('active');
            
            currentPhase = "";
            isGameEnding = false;
        }

        // üü¢ –°–¢–ê–†–¢
        function startSearching() {
            tg.HapticFeedback.impactOccurred('heavy');
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-search').classList.add('active');
            
            isGameEnding = false;
            startPolling();
        }

        // üü¢ –û–ü–†–û–° –°–ï–†–í–ï–†–ê
        function startPolling() {
            if (searchInterval) clearInterval(searchInterval);

            searchInterval = setInterval(async () => {
                try {
                    const response = await fetch(SEARCH_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: USER_ID, name: myName, photo: myPhoto })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'in_game') {
                        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç–∫—Ä–∞–Ω –∏–≥—Ä—ã
                        if (!document.getElementById('screen-game').classList.contains('active')) {
                            document.getElementById('screen-search').classList.remove('active');
                            document.getElementById('screen-game').classList.add('active');
                        }
                        updateGameUI(data);
                    }
                    else if (data.status === 'searching') {
                        // –ï—Å–ª–∏ –º—ã –±—ã–ª–∏ –≤ –∏–≥—Ä–µ, –Ω–æ —Å–µ—Ä–≤–µ—Ä —Å–∫–∞–∑–∞–ª "searching" -> –ò–ì–†–ê –£–î–ê–õ–ï–ù–ê
                        if (document.getElementById('screen-game').classList.contains('active')) {
                             if (!isGameEnding) {
                                 isGameEnding = true;
                                 log("Game deleted by server.");
                                 alert("–ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!");
                                 forceExit();
                             }
                        }
                    }
                } catch (error) { console.error("Poll err"); }
            }, 1000); 
        }

        // üü¢ –û–ë–ù–û–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê
        function updateGameUI(data) {
            // 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä (00:09)
            const timer = document.getElementById('game-timer');
            let tl = data.time_left;
            timer.innerText = `00:${tl < 10 ? '0'+tl : tl}`;
            
            document.getElementById('q-text-val').innerText = data.question;

            // 2. –°–æ–ø–µ—Ä–Ω–∏–∫
            const oppNameEl = document.getElementById('opponent-name');
            if (oppNameEl.innerText !== data.opponent_name) {
                oppNameEl.innerText = data.opponent_name;
                const oppAva = document.getElementById('opponent-avatar');
                const photo = (data.opponent_photo && data.opponent_photo !== "null") ? data.opponent_photo : 'https://randomuser.me/api/portraits/lego/1.jpg';
                oppAva.style.backgroundImage = `url('${photo}')`;
                oppAva.classList.add('blurred');
            }

            // 3. –°–º–µ–Ω–∞ –§–∞–∑
            if (currentPhase !== data.phase) {
                currentPhase = data.phase;
                log(`–§–ê–ó–ê: ${currentPhase}`);
                
                if (currentPhase === 'recording') {
                    document.getElementById('controls').style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É–ª—å—Ç
                    document.getElementById('player-box-content').style.display = 'none';
                    document.getElementById('q-box-content').style.display = 'block';
                    
                    // –ß–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –∑–Ω–∞—á–∫–∏ –¢–û–õ–¨–ö–û –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –∑–∞–ø–∏—Å–∏
                    document.querySelectorAll('.notify-badge').forEach(e => e.remove());
                } 
                else if (currentPhase === 'listening') {
                    document.getElementById('controls').style.display = 'none'; // –ü—Ä—è—á–µ–º –ø—É–ª—å—Ç
                    tg.HapticFeedback.notificationOccurred('warning');
                }
            }

            // 4. –ó–Ω–∞—á–æ–∫ Play (–ë–µ–∑ –º–∏–≥–∞–Ω–∏—è)
            if (data.phase === 'listening' && data.opponent_audio) {
                 const oppCard = document.getElementById('opponent-card');
                 
                 // –î–æ–±–∞–≤–ª—è–µ–º, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ –∑–Ω–∞—á–∫–∞
                 if (!oppCard.querySelector('.notify-badge')) {
                     const badge = document.createElement('div');
                     badge.className = 'notify-badge';
                     badge.innerText = '‚ñ∂Ô∏è';
                     oppCard.onclick = function() { playOpponentAudio(data.opponent_audio); };
                     oppCard.appendChild(badge);
                     tg.HapticFeedback.notificationOccurred('success');
                     log("–ó–Ω–∞—á–æ–∫ Play –¥–æ–±–∞–≤–ª–µ–Ω");
                 }
            }
        }

        // üü¢ –ê–£–î–ò–û
        function playOpponentAudio(audioUrl) {
             log("Play: " + audioUrl);
             tg.HapticFeedback.impactOccurred('medium');
             
             if (currentAudio) { currentAudio.pause(); }

             document.getElementById('q-box-content').style.display = 'none';
             const pBox = document.getElementById('player-box-content');
             pBox.style.display = 'flex';
             pBox.innerHTML = `
                <div class="play-btn" onclick="stopAudio()">‚è∏</div>
                <div style="font-size:10px; color:var(--neon-pink); margin-right:5px;">–°–õ–£–®–ê–ï–ú...</div>
                <div class="wave-visual"><div class="wave-fill" style="animation: fillWave 5s linear forwards;"></div></div>
            `;

            currentAudio = new Audio(audioUrl);
            currentAudio.play().catch(e => alert("Err: " + e));
            currentAudio.onended = function() { stopAudio(); };
        }

        function stopAudio() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            document.getElementById('player-box-content').style.display = 'none';
            document.getElementById('q-box-content').style.display = 'block';
        }

        // üü¢ –ó–ê–ü–ò–°–¨
        let isRecording = false;
        let mediaRecorder; 
        let audioChunks = []; 

        async function toggleRecording() {
            if (currentPhase !== 'recording') return;
            const btn = document.getElementById('mic-btn');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = sendAudioData;
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    tg.HapticFeedback.impactOccurred('medium');
                } catch (err) { alert('–ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞'); }
            } else {
                isRecording = false;
                btn.classList.remove('recording');
                if (mediaRecorder) mediaRecorder.stop();
            }
        }
        
        function sendAudioData() {
            if (audioChunks.length === 0) return;
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
            const formData = new FormData();
            formData.append('audio_file', audioBlob, `voice_${Date.now()}.ogg`);
            formData.append('user_id', USER_ID); 
            
            // –í—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–∑—É–∞–ª –æ—Ç–ø—Ä–∞–≤–∫–∏
            const pBox = document.getElementById('player-box-content');
            document.getElementById('q-box-content').style.display = 'none';
            pBox.style.display = 'flex';
            pBox.innerHTML = `<div style="color:#00ff88; font-size:12px;">–û–¢–ü–†–ê–í–ö–ê...</div>`;

            fetch(UPLOAD_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                pBox.style.display = 'none';
                document.getElementById('q-box-content').style.display = 'block';
                log("Upload OK");
            })
            .catch(err => alert('Err: ' + err));
        }

        function sendGift(type) { tg.HapticFeedback.impactOccurred('medium'); alert(`–ü–æ–¥–∞—Ä–æ–∫: ${type}`); }
        function buyPack() {}
    </script>
</body>
</html>
