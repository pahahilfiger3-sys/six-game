<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SIX</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="stylesheet" href="style.css"> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Orbitron', sans-serif; }
        
        /* –õ–û–ì–ò (–ß–µ—Ä–Ω–∞—è –ø–æ–ª–æ—Å–∞ —Å–Ω–∏–∑—É) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: rgba(0,0,0,0.85); color: #00ff00; font-size: 10px;
            font-family: monospace; overflow-y: scroll; z-index: 10000;
            padding: 5px; pointer-events: none; border-top: 2px solid #00ff00;
        }

        /* –ö–†–ê–°–ò–í–´–ô –õ–ï–ì–ö–ò–ô –ë–õ–Æ–† */
        .blurred {
            filter: blur(8px) brightness(0.8) !important;
            transition: filter 1s ease;
        }
        
        .unblurred {
            filter: blur(0px) !important;
        }

        /* –ó–ù–ê–ß–û–ö PLAY (–ß–µ—Ç–∫–∏–π, –ø–æ–≤–µ—Ä—Ö –≤—Å–µ–≥–æ) */
        .notify-badge {
            position: absolute;
            bottom: -5px; 
            right: -5px;
            width: 30px; height: 30px;
            background: #ff0055; 
            color: white;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            border: 2px solid white;
            box-shadow: 0 0 10px #ff0055;
            z-index: 100; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        .force-exit-btn {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255, 0, 0, 0.5); color: white;
            border: 1px solid red; font-size: 10px; padding: 5px;
            z-index: 5000; cursor: pointer;
        }

        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ—Å—Ç–∏ */
        .player-card { position: relative; }
    </style>
</head>
<body>

    <div id="debug-console">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="logo">SIX</div>
            <div class="online-tag">üü¢ ONLINE</div>
            <button class="big-btn" onclick="startSearching()">START</button>
            <div style="margin-top: 30px; opacity: 0.6; font-size: 12px;">–ë–∞–ª–∞–Ω—Å: <b id="user-balance">100 ü™ô</b></div>
            <div style="margin-top:10px; font-size:10px; color:#666;" id="debug-id"></div>
            <div style="margin-top:5px; font-size:10px; color:#666;" id="my-name-label"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active">üè†</div>
            <div class="nav-item">üí¨</div>
            <div class="nav-item">üõç</div>
            <div class="nav-item">üë§</div>
        </div>
    </div>

    <div id="screen-search" class="screen">
        <div style="flex-grow:1; display:flex; flex-direction:column; align-items:center; justify-content:center;">
            <div style="width:80px; height:80px; border:4px solid var(--neon-blue); border-radius:50%; border-top-color:transparent; animation:spin 1s linear infinite; margin-bottom:20px;"></div>
            <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
            <div>–ò—â–µ–º –ø–∞—Ä—É...</div>
            <button onclick="forceExit()" style="margin-top:20px; background:none; border:1px solid #444; color:#666;">–û–¢–ú–ï–ù–ê</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <button class="force-exit-btn" onclick="forceExit()">üö™ –í–´–ô–¢–ò</button>

        <div class="game-header"><span>TABLE #1</span><span id="game-timer">00:00</span></div>
        
        <div class="top-spotlight" id="top-bar">
            <div class="q-content" id="q-box-content">
                <div class="q-label">–†–ê–£–ù–î 1</div>
                <div class="q-text" id="q-text-val">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div class="player-content" id="player-box-content" style="display:none;">
                <div class="play-btn">‚ñ∂Ô∏è</div>
                <div class="wave-visual"><div class="wave-fill"></div></div>
                <div style="font-size:12px; font-weight:bold;">0:15</div>
            </div>
        </div>
        
        <div class="center-wrapper"> 
            <div class="table-grid">
                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/44.jpg')"></div><div class="name-tag">–ê–Ω—è</div></div>
                
                <div class="player-card team-left" id="opponent-card">
                    <div class="avatar" id="opponent-avatar"></div>
                    <div class="name-tag" id="opponent-name" style="color:var(--neon-pink)">...</div>
                </div>

                <div class="player-card team-left"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/women/68.jpg')"></div><div class="name-tag">–û–ª—è</div></div>
                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/32.jpg')"></div><div class="name-tag">–ú–∞–∫—Å</div></div>
                
                <div class="player-card team-right">
                    <div class="avatar" id="my-avatar"></div>
                    <div class="name-tag" style="color:var(--neon-blue)">–í–´</div>
                </div>

                <div class="player-card team-right"><div class="avatar" style="background-image:url('https://randomuser.me/api/portraits/men/86.jpg')"></div><div class="name-tag">–î—ç–Ω</div></div>
            </div>
        </div>

        <div class="controls-container" id="controls">
            
            <div class="side-col left">
                <div class="gift-btn" onclick="sendGift('ice')">
                    <svg class="gift-icon" viewBox="0 0 24 24" style="fill:#00f3ff;"><path d="M12,2L4,6v12l8,4l8-4V6L12,2z M12,18.5L6.5,15.8V8.2L12,11V18.5z M12,9L6.5,6.3L12,3.5l5.5,2.8L12,9z M17.5,15.8 L12,18.5V11l5.5-2.8V15.8z"/></svg>
                    <div class="gift-price">10</div>
                </div>
                <div class="gift-btn" onclick="sendGift('fire')">
                    <svg class="gift-icon" viewBox="0 0 24 24" style="fill:#ff5500;"><path d="M13.5.67s.74 2.65.74 4.8c0 2.06-1.35 3.73-3.41 3.73-2.07 0-3.63-1.67-3.63-3.73l.03-.36C5.21 7.51 4 10.62 4 14c0 4.42 3.58 8 8 8s8-3.58 8-8C20 8.61 17.41 3.8 13.5.67zM11.71 19c-1.78 0-3.22-1.4-3.22-3.14 0-1.62 1.05-2.76 2.81-3.12 1.77-.36 3.6-1.21 4.62-2.58.39 1.29.59 2.65.59 4.04 0 2.65-2.15 4.8-4.8 4.8z"/></svg>
                    <div class="gift-price">25</div>
                </div>
            </div>

            <div class="mic-wrapper" id="mic-wrapper">
                <button class="mic-btn" id="mic-btn" onclick="toggleRecording()">
                    <svg class="mic-icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
                </button>
            </div>

            <div class="side-col right">
                <div class="gift-btn" onclick="sendGift('spy')">
                    <svg class="gift-icon" viewBox="0 0 24 24" style="fill:#ffd700;"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    <div class="gift-price">100</div>
                </div>
                <div class="gift-btn" onclick="sendGift('drink')">
                    <svg class="gift-icon" viewBox="0 0 24 24" style="fill:#ff00ff;"><path d="M21 5V3H3v2l8 9v5H6v2h12v-2h-5v-5l8-9zM7.43 7L5.66 5h12.69l-1.78 2H7.43z"/></svg>
                    <div class="gift-price">50</div>
                </div>
            </div>
            
        </div>
    </div>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor('#0b0b14'); tg.setBackgroundColor('#0b0b14');

        function log(msg) {
            const el = document.getElementById('debug-console');
            el.innerText = msg + "\n" + el.innerText;
            console.log(msg);
        }

        const UPLOAD_URL = 'https://api.sixapp.online/audio/upload';
        const SEARCH_URL = 'https://api.sixapp.online/search';

        const u = tg.initDataUnsafe.user;
        let USER_ID;
        let myName = "–ò–≥—Ä–æ–∫"; 
        let myPhoto = "";

        const testNames = ["–ê–ª–µ–∫—Å", "–ú–∞–∫—Å", "–î—ç–Ω", "–û–ª—è", "–ö–∞—Ç—è", "–ù–∏–∫", "–õ–∏–∑–∞"];
        const randomNum = Math.floor(Math.random() * 999);
        const randomName = testNames[Math.floor(Math.random() * testNames.length)] + " #" + randomNum;

        if (u && u.id) {
            log(`TG User: ${u.first_name} (${u.id})`);
            USER_ID = u.id;
            myName = u.first_name || "–ê–Ω–æ–Ω–∏–º";
            myPhoto = u.photo_url || "";
        } else {
            log("Browser Mode");
            let storedId = localStorage.getItem('six_real_id_v3'); 
            if (!storedId) {
                storedId = Math.floor(Math.random() * 1000000) + 1;
                localStorage.setItem('six_real_id_v3', storedId);
            }
            USER_ID = parseInt(storedId);
            let storedName = localStorage.getItem('six_test_name_v3');
            if (!storedName) {
                storedName = randomName;
                localStorage.setItem('six_test_name_v3', storedName);
            }
            myName = storedName;
        }

        document.getElementById('debug-id').innerText = "ID: " + USER_ID;
        document.getElementById('my-name-label').innerText = myName;

        if (myPhoto) {
            document.getElementById('my-avatar').style.backgroundImage = `url('${myPhoto}')`;
        }

        let searchInterval;
        let currentPhase = "";
        let currentAudio = null;

        function forceExit() {
            log("üö™ –í–´–•–û–î");
            clearInterval(searchInterval);
            document.getElementById('screen-game').classList.remove('active');
            document.getElementById('screen-search').classList.remove('active');
            document.getElementById('screen-lobby').classList.add('active');
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            currentPhase = "";
        }

        async function checkActiveGame() {
            try {
                const response = await fetch(SEARCH_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: USER_ID, name: myName, photo: myPhoto })
                });
                const data = await response.json();

                if (data.status === 'in_game') {
                    log("‚ôªÔ∏è RECONNECT...");
                    document.getElementById('screen-lobby').classList.remove('active');
                    document.getElementById('screen-game').classList.add('active');
                    startPolling();
                }
            } catch (e) { log("Check err: " + e); }
        }

        async function startSearching() {
            tg.HapticFeedback.impactOccurred('heavy');
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-search').classList.add('active');
            startPolling();
        }

        function startPolling() {
            if (searchInterval) clearInterval(searchInterval);

            searchInterval = setInterval(async () => {
                try {
                    const response = await fetch(SEARCH_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_id: USER_ID, name: myName, photo: myPhoto })
                    });
                    const data = await response.json();
                    
                    if (data.status === 'in_game') {
                        if (!document.getElementById('screen-game').classList.contains('active')) {
                            document.getElementById('screen-search').classList.remove('active');
                            document.getElementById('screen-game').classList.add('active');
                        }
                        updateGameUI(data);
                    }
                    else if (data.status === 'searching') {
                        if (document.getElementById('screen-game').classList.contains('active')) {
                             log("–ò–≥—Ä–∞ —É–¥–∞–ª–µ–Ω–∞.");
                             forceExit();
                        }
                    }
                } catch (error) { console.error("Poll err"); }
            }, 1000); 
        }

        function updateGameUI(data) {
            const timer = document.getElementById('game-timer');
            timer.innerText = `00:${data.time_left}`;
            document.getElementById('q-text-val').innerText = data.question;

            const oppNameEl = document.getElementById('opponent-name');
            if (oppNameEl.innerText !== data.opponent_name) {
                oppNameEl.innerText = data.opponent_name;
                const oppAva = document.getElementById('opponent-avatar');
                const photo = (data.opponent_photo && data.opponent_photo !== "null") ? data.opponent_photo : 'https://randomuser.me/api/portraits/lego/1.jpg';
                oppAva.style.backgroundImage = `url('${photo}')`;
                oppAva.classList.add('blurred');
            }

            if (currentPhase !== data.phase) {
                currentPhase = data.phase;
                log(`–§–ê–ó–ê: ${currentPhase}`);
                
                if (currentPhase === 'recording') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å
                    document.getElementById('controls').style.display = 'flex';
                    document.getElementById('player-box-content').style.display = 'none';
                    document.getElementById('q-box-content').style.display = 'block';
                    document.querySelectorAll('.notify-badge').forEach(e => e.remove());
                } 
                else if (currentPhase === 'listening') {
                    // –ü—Ä—è—á–µ–º –Ω–∏–∂–Ω—é—é –ø–∞–Ω–µ–ª—å (–∏–ª–∏ —Ç–æ–ª—å–∫–æ –º–∏–∫—Ä–æ—Ñ–æ–Ω)
                    // –î–ª—è –∫—Ä–∞—Å–æ—Ç—ã —Å–∫—Ä–æ–µ–º –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, –Ω–æ –ø–æ–¥–∞—Ä–∫–∏ –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å
                    document.getElementById('mic-wrapper').style.visibility = 'hidden'; 
                    tg.HapticFeedback.notificationOccurred('warning');
                }
            }

            if (data.phase === 'listening' && data.opponent_audio) {
                 const oppCard = document.getElementById('opponent-card');
                 if (!oppCard.querySelector('.notify-badge')) {
                     log("‚úÖ –ö–ù–û–ü–ö–ê PLAY!");
                     const badge = document.createElement('div');
                     badge.className = 'notify-badge';
                     badge.innerText = '‚ñ∂Ô∏è';
                     oppCard.onclick = function() { playOpponentAudio(data.opponent_audio); };
                     oppCard.appendChild(badge);
                     tg.HapticFeedback.notificationOccurred('success');
                 }
            }
        }

        function playOpponentAudio(audioUrl) {
             log("Play: " + audioUrl);
             tg.HapticFeedback.impactOccurred('medium');
             if (currentAudio) { currentAudio.pause(); currentAudio = null; }

             document.getElementById('q-box-content').style.display = 'none';
             const pBox = document.getElementById('player-box-content');
             pBox.style.display = 'flex';
             pBox.innerHTML = `
                <div class="play-btn" onclick="stopAudio()">‚è∏</div>
                <div style="font-size:10px; color:var(--neon-pink); margin-right:5px;">–°–û–ü–ï–†–ù–ò–ö</div>
                <div class="wave-visual"><div class="wave-fill" style="animation: fillWave 5s linear forwards;"></div></div>
            `;
            currentAudio = new Audio(audioUrl);
            currentAudio.play().catch(e => { log("Err: " + e); });
            currentAudio.onended = function() { stopAudio(); };
        }

        function stopAudio() {
            if (currentAudio) { currentAudio.pause(); currentAudio = null; }
            document.getElementById('player-box-content').style.display = 'none';
            document.getElementById('q-box-content').style.display = 'block';
        }

        let isRecording = false;
        let mediaRecorder; 
        let audioChunks = []; 

        async function toggleRecording() {
            if (currentPhase !== 'recording') return;
            const btn = document.getElementById('mic-btn');
            const playerBox = document.getElementById('player-box-content');
            
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = sendAudioData;
                    audioChunks = [];
                    mediaRecorder.start();
                    isRecording = true;
                    btn.classList.add('recording');
                    tg.HapticFeedback.impactOccurred('medium');
                    document.getElementById('q-box-content').style.display = 'none';
                    if(playerBox) {
                        playerBox.style.display = 'flex';
                        playerBox.innerHTML = `<div style="color:red; font-size:12px;">–ó–ê–ü–ò–°–¨...</div>`;
                    }
                    log("Mic ON");
                } catch (err) { alert('–ù–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞'); }
            } else {
                isRecording = false;
                btn.classList.remove('recording');
                if (mediaRecorder) mediaRecorder.stop();
                log("Mic OFF");
                if(playerBox) playerBox.innerHTML = `<div style="color:#00ff88; font-size:12px;">–û–¢–ü–†–ê–í–ö–ê...</div>`;
            }
        }
        
        function sendAudioData() {
            if (audioChunks.length === 0) return;
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' });
            const formData = new FormData();
            formData.append('audio_file', audioBlob, `voice_${Date.now()}.ogg`);
            formData.append('user_id', USER_ID); 

            fetch(UPLOAD_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                log("Upload: " + data.status);
                const pBox = document.getElementById('player-box-content');
                const qBox = document.getElementById('q-box-content');
                if (pBox) pBox.style.display = 'none';
                if (qBox) qBox.style.display = 'block';
            })
            .catch(err => log('Err: ' + err));
        }

        function sendGift(type) { tg.HapticFeedback.impactOccurred('medium'); alert(`–ü–æ–¥–∞—Ä–æ–∫: ${type}`); }
        function voteFor(name) {}
        function skipVote() {}
        function buyPack() { tg.sendData(JSON.stringify({action:"buy_pack"})); }
        function closeApp() { tg.close(); }

        checkActiveGame();
    </script>
</body>
</html>
