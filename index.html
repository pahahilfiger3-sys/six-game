<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIX | UNMUTE</title>
    <link rel="stylesheet" href="style.css"> 
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;800&display=swap"> 
    <style>
        /* * –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–æ–≤—ã–π —à—Ä–∏—Ñ—Ç –∫ body */
        body { font-family: 'Orbitron', sans-serif; }

        /* –í–ê–®–ò –°–¢–ò–õ–ò –î–õ–Ø –°–ö–†–´–¢–ò–Ø/–ü–û–ö–ê–ó–ê –≠–ö–†–ê–ù–û–í */
        .screen { display: none; }
        .screen.active { display: block; }
        .recording { background-color: #ff004c !important; }
        .blurred { filter: blur(10px); }
        .unblurred { filter: none; }
        
        /* –í–†–ï–ú–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –¢–ï–°–¢–ê –ö–ù–û–ü–û–ö */
        .big-btn { 
            padding: 15px 30px; 
            background: #00ff88; 
            color: #0b0b14; 
            border: none; 
            cursor: pointer; 
            font-size: 1.2em;
            margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="screen-lobby" class="screen active">
        <div class="lobby-container">
            <div class="logo">SIX</div>
            <div class="online-tag">üü¢ 1,240 Online</div>
            <button class="big-btn" onclick="startSearching()">START</button>
            <div style="margin-top: 30px; opacity: 0.6; font-size: 12px;">–ë–∞–ª–∞–Ω—Å: <b id="user-balance">100</b> –ß–ò–ü–°–û–í</div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active">üî•</div>
            <div class="nav-item" onclick="buyPack()">üí∞</div>
            </div>
    </div>
    
    <div id="screen-game" class="screen">
        <div id="top-bar">–¢–∞–π–º–µ—Ä: <span id="game-timer">00:15</span></div>
        <div class="player-card" id="opponent-avatar"></div>
        <div id="opponent-name"></div>
        
        <div id="q-box-content">
            <p>–í–æ–ø—Ä–æ—Å:</p>
            <h2 id="q-text-val">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
        </div>
        
        <div id="player-box-content" style="display: none;">
            </div>

        <div id="controls">
            <button id="mic-btn" onclick="toggleRecording()">üé§</button>
            <button onclick="sendGift('ice')">üßä</button>
            <button onclick="sendGift('fire')">üî•</button>
        </div>
    </div>

    <script>
        // =================================================================
        //                 –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        // =================================================================
        let tg = window.Telegram.WebApp;
        tg.expand();

        // üü¢ –°–ò–°–¢–ï–ú–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò TG
        tg.setHeaderColor('#0b0b14'); 
        tg.setBackgroundColor('#0b0b14'); 

        // --- üîí –ë–ï–ó–û–ü–ê–°–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ API ---
        const USER_ID = 726765325; // ‚¨ÖÔ∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–û –ù–ê –í–ê–® –¢–ï–°–¢–û–í–´–ô Telegram USER ID
        const UPLOAD_URL = 'https://api.sixapp.online/audio/upload';
        
        // ----------------------------------------------------

        // –û–±—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const u = tg.initDataUnsafe.user;
        const myPhoto = (u && u.photo_url) ? u.photo_url : "";
        
        let currentQuestion = "";
        let isRecording = false;
        let mediaRecorder; 
        let audioChunks = []; 
        let stream;
        
        // --- –ü–æ–ª—É—á–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ DOM (–µ—Å–ª–∏ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è) ---
        // const startButton = document.getElementById('startRecord'); // (–£–¥–∞–ª–µ–Ω—ã –∏–∑ UI)
        // const stopButton = document.getElementById('stopRecord'); // (–£–¥–∞–ª–µ–Ω—ã –∏–∑ UI)

        // =================================================================
        //             –õ–û–ì–ò–ö–ê –ó–ê–ì–†–£–ó–ö–ò (INITIALIZATION)
        // =================================================================

        if (myPhoto) {
            // document.getElementById('my-avatar').style.backgroundImage = `url('${myPhoto}')`;
            // document.getElementById('final-my-ava').style.backgroundImage = `url('${myPhoto}')`;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const mode = urlParams.get('mode');

        // –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ URL (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/–±–æ—Ç–∞)
        if (mode === 'game') {
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            setupGame();
        } else if (mode === 'search') {
            // –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ–∏—Å–∫–∞
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-search').classList.add('active');
        }
        
        // -----------------------------------------------------------------
        //                –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        // -----------------------------------------------------------------

        // üü¢ –õ–û–ì–ò–ö–ê –ö–ù–û–ü–ö–ò START (–ù–∞—á–∏–Ω–∞–µ—Ç –ø–æ–∏—Å–∫/–∏–≥—Ä—É)
        function startSearching() {
            // alert("–ö–ù–û–ü–ö–ê –†–ê–ë–û–¢–ê–ï–¢"); // <--- –£–î–ê–õ–ò–¢–¨ –ü–û–°–õ–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø!

            // üü¢ –í–†–ï–ú–ï–ù–ù–´–ô –•–ê–ö –î–õ–Ø –¢–ï–°–¢–ê (–£–¥–∞–ª–∏—Ç—å, –∫–æ–≥–¥–∞ –±–æ—Ç –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤)
            document.getElementById('screen-lobby').classList.remove('active');
            document.getElementById('screen-game').classList.add('active');
            setupGame();
            // –ö–û–ù–ï–¶ –•–ê–ö–ê
            
            tg.HapticFeedback.impactOccurred('heavy');
            // tg.sendData(JSON.stringify({action:"search", photo: myPhoto})); // –†–µ–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
        }

        function setupGame() {
            // ... (–í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä—ã) ...
            const q1 = decodeURIComponent(urlParams.get('q1') || "–†–∞—Å—Å–∫–∞–∂–∏ —Å–≤–æ–π —Å–∞–º—ã–π —Å—Ç—ã–¥–Ω—ã–π –ø–æ—Å—Ç—É–ø–æ–∫?");
            const q2 = decodeURIComponent(urlParams.get('q2') || "–¢–≤–æ–π –∏–¥–µ–∞–ª—å–Ω—ã–π –≤—ã—Ö–æ–¥–Ω–æ–π?");
            
            const oppName = decodeURIComponent(urlParams.get('opp_name') || "–ö–∞—Ç—è");
            const oppPhoto = decodeURIComponent(urlParams.get('opp_photo') || "");
            
            document.getElementById('opponent-name').innerText = oppName;
            const oppAva = document.getElementById('opponent-avatar');
            // ... (–¥—Ä—É–≥–∞—è –ª–æ–≥–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) ...
            
            oppAva.classList.add('blurred');
            runRound(1, q1, q2);
        }

        function runRound(num, q1, q2) {
            // ... (–í–∞—à–∞ –ª–æ–≥–∏–∫–∞ —Ä–∞—É–Ω–¥–æ–≤) ...
            const text = (num === 1) ? q1 : q2;
            currentQuestion = text; 
            
            document.getElementById('q-text-val').innerText = text;
            
            let timeLeft = 15; // 15 —Å–µ–∫ —Ä–∞—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞
            const timer = document.getElementById('game-timer');
            const interval = setInterval(() => {
                timeLeft--;
                timer.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                if (timeLeft <= 0) {
                    clearInterval(interval);
                    if (num === 1) {
                        runRound(2, q1, q2);
                    } else {
                        endGame();
                    }
                }
            }, 1000);
        }

        // -----------------------------------------------------------------
        //               –õ–û–ì–ò–ö–ê –ó–ê–ü–ò–°–ò –ò –û–¢–ü–†–ê–í–ö–ò –ê–£–î–ò–û (–ò–°–ü–†–ê–í–õ–ï–ù–û)
        // -----------------------------------------------------------------

        // üü¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å—å—é (–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π üé§)
        async function toggleRecording() {
            const btn = document.getElementById('mic-btn');
            const qBox = document.getElementById('q-box-content');
            const playerBox = document.getElementById('player-box-content');
            const gameScreen = document.getElementById('screen-game');
            
            if (!isRecording) {
                // --- –°–¢–ê–†–¢ –ó–ê–ü–ò–°–ò ---
                try {
                    // 1. –ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = sendAudioData; // –ß—Ç–æ –¥–µ–ª–∞—Ç—å, –∫–æ–≥–¥–∞ –∑–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
                    
                    audioChunks = [];
                    mediaRecorder.start();

                    isRecording = true;
                    // ... (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI) ...
                    
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø.');
                    return;
                }

            } else {
                // --- –°–¢–û–ü –ó–ê–ü–ò–°–ò ---
                isRecording = false;
                // ... (–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI) ...
                
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
            }
        }
        
        // üü¢ –û–¢–ü–†–ê–í–ö–ê –ê–£–î–ò–û–§–ê–ô–õ–ê –ß–ï–†–ï–ó HTTPS –ù–ê VPS (–ò–°–ü–†–ê–í–õ–ï–ù–û)
        function sendAudioData() {
            // üõ†Ô∏è FIX: –ü—Ä–æ–±–ª–µ–º–∞ 422 - –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä
            if (audioChunks.length === 0) {
                 alert("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: –ê—É–¥–∏–æ—Ñ–∞–π–ª –ø—É—Å—Ç.");
                 return;
            }
            
            // üõ†Ô∏è FIX: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ audioBlob –æ–±—ä—è–≤–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å (–±–µ–∑ SyntaxError)
            const audioBlob = new Blob(audioChunks, { type: 'audio/ogg; codecs=opus' }); 
            
            const formData = new FormData();
            formData.append('audio_file', audioBlob, `voice_${Date.now()}.ogg`);
            formData.append('user_id', USER_ID); // –ü–µ—Ä–µ–¥–∞–µ–º User ID

            fetch(UPLOAD_URL, {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                const playerBox = document.getElementById('player-box-content');
                if (!response.ok) {
                    playerBox.innerHTML = `<div style="color:red; font-size:12px;">‚ùå –û–®–ò–ë–ö–ê –°–ï–†–í–ï–†–ê: ${response.status}</div>`;
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                // ... (–õ–æ–≥–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ UI) ...
                return response.json();
            })
            .then(data => {
                if (data.status === 'success') {
                    alert('‚úÖ –ê—É–¥–∏–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É!');
                } else {
                    alert('‚ö†Ô∏è –ê—É–¥–∏–æ –ø–æ–ª—É—á–µ–Ω–æ, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ' + data.message);
                }
            })
            .catch(error => {
                alert('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
            });
        }
        
        // -----------------------------------------------------------------
        //               –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–°–æ—Ö—Ä–∞–Ω–µ–Ω—ã)
        // -----------------------------------------------------------------

        function sendGift(type) {
            // ...
        }
        function spotlightPlayer(name) {
            // ...
        }
        function endGame() {
            // ...
        }
        function voteFor(name) {
            // ...
        }
        function skipVote() { voteFor('–ù–∏–∫—Ç–æ'); }
        function buyPack() { tg.sendData(JSON.stringify({action:"buy_pack"})); }
        function closeApp() { tg.close(); }

        // ... (–í–∞—à–∏ —Ñ—É–Ω–∫—Ü–∏–∏ showZoom, document.getElementById('zoom-overlay').onclick) ...

    </script>
</body>
</html>
